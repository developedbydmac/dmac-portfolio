name: üöÄ Deploy D Mac Portfolio to AWS

on:
  push:
    branches: [ main, master ]
    paths: 
      - '**.html'
      - '**.css' 
      - '**.js'
      - 'assets/**'
      - 'devops/aws/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'devops/aws/**'
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Validate HTML files
      run: |
        echo "üîç Validating HTML structure..."
        
        # Check if required files exist
        required_files=("index.html" "resume.html" "projects.html" "blog.html")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Required file $file is missing"
            exit 1
          else
            echo "‚úÖ Found $file"
          fi
        done
        
        # Basic HTML validation
        for html_file in *.html; do
          if [ -f "$html_file" ]; then
            echo "üìÑ Checking $html_file..."
            
            # Check for DOCTYPE
            if ! grep -q "<!DOCTYPE" "$html_file"; then
              echo "‚ö†Ô∏è  Warning: $html_file is missing DOCTYPE declaration"
            fi
            
            # Check for basic HTML structure
            if ! grep -q "<html" "$html_file"; then
              echo "‚ùå Error: $html_file is missing <html> tag"
              exit 1
            fi
            
            if ! grep -q "<head>" "$html_file"; then
              echo "‚ùå Error: $html_file is missing <head> section"
              exit 1
            fi
            
            if ! grep -q "<body>" "$html_file"; then
              echo "‚ùå Error: $html_file is missing <body> section"
              exit 1
            fi
            
            echo "‚úÖ $html_file structure looks good"
          fi
        done
        
    - name: üé® Check CSS files
      run: |
        echo "üé® Checking CSS files..."
        if [ -f "styles/main.css" ]; then
          echo "‚úÖ Found main CSS file"
          # Basic CSS validation - check for syntax errors
          if grep -q "{" styles/main.css && grep -q "}" styles/main.css; then
            echo "‚úÖ CSS file appears to have valid syntax"
          else
            echo "‚ö†Ô∏è  Warning: CSS file might have syntax issues"
          fi
        else
          echo "‚ö†Ô∏è  Warning: No main CSS file found"
        fi
        
    - name: üìä Check assets
      run: |
        echo "üìä Checking assets..."
        if [ -d "assets" ]; then
          echo "‚úÖ Assets directory found"
          echo "üìÅ Assets found:"
          find assets -type f | head -10
        else
          echo "‚ö†Ô∏è  Warning: No assets directory found"
        fi
        
    - name: üß™ Run custom build script
      run: |
        if [ -f "build.sh" ]; then
          echo "üß™ Running custom build script..."
          chmod +x build.sh
          ./build.sh
        else
          echo "‚ÑπÔ∏è  No custom build script found, skipping..."
        fi
        
    - name: üì¶ Create deployment package
      run: |
        echo "üì¶ Creating deployment package..."
        
        # Create a clean build directory
        mkdir -p build
        
        # Copy all necessary files
        cp *.html build/ 2>/dev/null || echo "No HTML files in root"
        
        # Copy directories
        [ -d "assets" ] && cp -r assets build/
        [ -d "styles" ] && cp -r styles build/
        [ -d "scripts" ] && cp -r scripts build/
        [ -d "components" ] && cp -r components build/
        [ -d "experience" ] && cp -r experience build/
        
        # Create a simple 404 page if it doesn't exist
        if [ ! -f "build/404.html" ]; then
          cat > build/404.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>404 - Page Not Found | D Mac Portfolio</title>
          <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
            h1 { color: #333; }
            a { color: #007bff; text-decoration: none; }
            a:hover { text-decoration: underline; }
          </style>
        </head>
        <body>
          <h1>404 - Page Not Found</h1>
          <p>The page you're looking for doesn't exist.</p>
          <a href="/">‚Üê Back to Home</a>
        </body>
        </html>
        EOF
        fi
        
        # Create AWS-specific content
        cat > build/aws-info.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>AWS Deployment Info | D Mac Portfolio</title>
          <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: linear-gradient(135deg, #232f3e, #ff9900); color: white; }
            .container { max-width: 600px; margin: 0 auto; }
            h1 { color: #fff; margin-bottom: 30px; }
            .aws-badge { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin: 20px 0; }
            a { color: #fff; text-decoration: none; font-weight: bold; }
            a:hover { text-decoration: underline; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>üî∂ AWS Deployment</h1>
            <div class="aws-badge">
              <h3>Powered by Amazon Web Services</h3>
              <p>This portfolio is built on AWS's enterprise-grade infrastructure for maximum reliability and performance.</p>
              <p><strong>Features:</strong></p>
              <ul style="text-align: left;">
                <li>S3 Static Website Hosting with versioning</li>
                <li>CloudFront CDN with global edge locations</li>
                <li>Route53 DNS with health checks</li>
                <li>99.99% uptime SLA</li>
                <li>Auto-scaling and enterprise security</li>
              </ul>
            </div>
            <a href="/">‚Üê Back to Portfolio</a>
          </div>
        </body>
        </html>
        EOF
        
        echo "‚úÖ Build package created"
        echo "üìÅ Build contents:"
        ls -la build/
        
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: portfolio-build
        path: build/
        retention-days: 7

  # Job 2: Deploy to AWS (only on main/master branch)
  deploy:
    name: üöÄ Deploy to AWS
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: üì• Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: portfolio-build
        path: build/
        
    - name: üîß Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: üì§ Deploy to S3
      run: |
        echo "üì§ Deploying to S3 bucket: $S3_BUCKET"
        
        # Sync files to S3 with proper content types and caching
        aws s3 sync build/ s3://$S3_BUCKET/ \
          --delete \
          --cache-control "public, max-age=3600" \
          --metadata-directive REPLACE
          
        # Set longer cache for static assets
        if [ -d "build/assets" ]; then
          aws s3 sync build/assets/ s3://$S3_BUCKET/assets/ \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE
        fi
        
        # Set shorter cache for HTML files
        aws s3 sync build/ s3://$S3_BUCKET/ \
          --exclude "*" \
          --include "*.html" \
          --cache-control "public, max-age=300" \
          --metadata-directive REPLACE
          
        echo "‚úÖ S3 deployment completed"
        
    - name: üîÑ Invalidate CloudFront cache
      run: |
        echo "üîÑ Invalidating CloudFront cache..."
        
        invalidation_id=$(aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
          --paths "/*" \
          --query 'Invalidation.Id' \
          --output text)
          
        echo "‚úÖ CloudFront invalidation created: $invalidation_id"
        echo "üïê Cache invalidation may take 5-15 minutes to complete"
        
    - name: üåê Get website URL
      run: |
        echo "üåê Deployment completed successfully!"
        
        # Get CloudFront distribution domain
        distribution_domain=$(aws cloudfront get-distribution \
          --id $CLOUDFRONT_DISTRIBUTION_ID \
          --query 'Distribution.DomainName' \
          --output text)
          
        echo "üöÄ Your portfolio is now live at:"
        echo "   https://$distribution_domain"
        
        # If using a custom domain, that would be displayed too
        echo ""
        echo "‚ú® D Mac Portfolio deployment complete! ‚ú®"

  # Job 3: Lighthouse Performance Check (optional)
  lighthouse:
    name: üîç Lighthouse Performance Check
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîß Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: üåê Get website URL
      id: get-url
      run: |
        distribution_domain=$(aws cloudfront get-distribution \
          --id $CLOUDFRONT_DISTRIBUTION_ID \
          --query 'Distribution.DomainName' \
          --output text)
        echo "website_url=https://$distribution_domain" >> $GITHUB_OUTPUT
        
    - name: üîç Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ steps.get-url.outputs.website_url }}
        budgetPath: .lighthousebudget.json
        uploadArtifacts: true
        temporaryPublicStorage: true
